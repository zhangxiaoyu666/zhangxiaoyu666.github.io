<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="肩膀有点痒，可能在长小翅膀">
<meta property="og:type" content="website">
<meta property="og:title" content="一只鱼的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="一只鱼的博客">
<meta property="og:description" content="肩膀有点痒，可能在长小翅膀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一只鱼的博客">
<meta name="twitter:description" content="肩膀有点痒，可能在长小翅膀">
  <link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>一只鱼的博客</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一只鱼的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">七秒钟的记忆多一秒</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-question-circle"></i>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
      
        
      
        
      
        
          
        
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-question-circle"></i>标签<span class="badge">45</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
      
        
      
        
          
        
      
        
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-question-circle"></i>分类<span class="badge">10</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
      
        
          
        
      
        
      
        
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-question-circle"></i>归档<span class="badge">67</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-schedule">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/schedule/" rel="section"><i class="fa fa-fw fa-calendar"></i>日程表</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-sitemap">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-commonweal">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/404/" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/数据仓库建模/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/数据仓库建模/" class="post-title-link" itemprop="url">数据仓库建模</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 21:59:47 / 修改时间：22:46:41" itemprop="dateCreated datePublished" datetime="2020-03-09T21:59:47+08:00">2020-03-09</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据项目开发/" itemprop="url" rel="index"><span itemprop="name">大数据项目开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="维度建模"><a href="#维度建模" class="headerlink" title="维度建模"></a>维度建模</h1><p>两种不同的建模思想，Inmon和Kimball是最常见的两种架构。</p>
<h2 id="Inmon架构"><a href="#Inmon架构" class="headerlink" title="Inmon架构"></a>Inmon架构</h2><p>Inmon主张自上而下的架构，它将数据仓库定义为整个企业级的集中存储。数据仓库存放着最低的详细级别的原子数据。维度数据集市只是在数据仓库完成后才创建的。因此，数据仓库是企业信息工厂（CIF）的中心，它为交付商业智能提供逻辑框架。</p>
<p>不同的OLTP数据集中到面向主题、集成的、不易失的和时间变化的结构中，用于以后的分析。且数据可以通过下钻到最细层，或者上卷到汇总层。数据集市应该是数据仓库的子集，每个数据集市是针对独立部门特殊设计的。</p>
<p><img src="/2020/03/09/数据仓库建模/1583764012962.png" alt="1583764012962"></p>
<h2 id="Kimball架构"><a href="#Kimball架构" class="headerlink" title="Kimball架构"></a>Kimball架构</h2><p>Kimball正好与Inmon相反，Kimball架构是一种自下而上的架构，它认为数据仓库是一系列数据集市的集合。它首先建立最重要的业务单元或部门的数据集市。这些数据集市可以为透视组织数据提供一个较窄的视图，需要的时候，这些数据集市还可以与更大的数据仓库合并在一起。</p>
<p>Kimball将数据仓库定义为“一份针对查询和分析做特别结构化的事物数据拷贝。”Kimball的数据仓库结构就是著名的数据仓库总线。企业可以通过一系列维数相同的数据集市递增地构建数据仓库，通过使用一致的维度，能够共同看到不同数据集市中的信息，这表示它们拥有公共定义的元素。</p>
<p><img src="/2020/03/09/数据仓库建模/1583764094677.png" alt="1583764094677"></p>
<h2 id="两种架构对比"><a href="#两种架构对比" class="headerlink" title="两种架构对比"></a>两种架构对比</h2><p>两种模式各有优势，Inmon模式适合开发进度慢，实施成本高，适合对设计科学性和规范性较高的企业，在业务模式较固定的行业应用较好，比如金融和电信等行业。Kimball 模式适合快速迭代，实施成本低，能够较快交付任务。这种模式非常适应互联网行业的高速发展，也适合中小型企业。</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/数据仓库建设规范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/数据仓库建设规范/" class="post-title-link" itemprop="url">数据仓库建设规范</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 20:38:46 / 修改时间：21:47:46" itemprop="dateCreated datePublished" datetime="2020-03-09T20:38:46+08:00">2020-03-09</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据项目开发/" itemprop="url" rel="index"><span itemprop="name">大数据项目开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据日志采集"><a href="#数据日志采集" class="headerlink" title="数据日志采集"></a>数据日志采集</h1><ol>
<li>数据传输与协议，日志格式化存储在游戏服务器上，一份表分库形式存在，每个月一个表。</li></ol>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2020/03/09/数据仓库建设规范/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/游戏业务日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/游戏业务日志/" class="post-title-link" itemprop="url">游戏日志业务日志</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 19:26:01 / 修改时间：20:18:51" itemprop="dateCreated datePublished" datetime="2020-03-09T19:26:01+08:00">2020-03-09</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据项目开发/" itemprop="url" rel="index"><span itemprop="name">大数据项目开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="游戏行业背景"><a href="#游戏行业背景" class="headerlink" title="游戏行业背景"></a>游戏行业背景</h1><p>现在的市面上很多游戏公司主要分类两大类：一是游戏研发类，二是游戏运营类。</p>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2020/03/09/游戏业务日志/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/游戏数据集市层/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/游戏数据集市层/" class="post-title-link" itemprop="url">游戏数据集市层</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 19:21:52" itemprop="dateCreated datePublished" datetime="2020-03-09T19:21:52+08:00">2020-03-09</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/游戏行业指标体系/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/游戏行业指标体系/" class="post-title-link" itemprop="url">游戏行业指标体系</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 19:20:41" itemprop="dateCreated datePublished" datetime="2020-03-09T19:20:41+08:00">2020-03-09</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/DW中间层/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/DW中间层/" class="post-title-link" itemprop="url">DW中间层</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 19:20:15" itemprop="dateCreated datePublished" datetime="2020-03-09T19:20:15+08:00">2020-03-09</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/游戏数仓的架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/游戏数仓的架构/" class="post-title-link" itemprop="url">游戏数仓的架构</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 19:18:51 / 修改时间：22:01:07" itemprop="dateCreated datePublished" datetime="2020-03-09T19:18:51+08:00">2020-03-09</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据项目开发/" itemprop="url" rel="index"><span itemprop="name">大数据项目开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据仓库的特点和意义"><a href="#数据仓库的特点和意义" class="headerlink" title="数据仓库的特点和意义"></a>数据仓库的特点和意义</h1><p>现在互联网时代的电子商务，门户网站都会产生海量的数据，并且都可以通过对数据的挖掘和分析来提升转化率和转化收益。国内外都有专门提供数据分析服务的公司，比如国内最早深入游戏领域的TalkingData 的 Game Analytics，</p>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2020/03/09/游戏数仓的架构/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/ODS数据原始层设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/09/ODS数据原始层设计/" class="post-title-link" itemprop="url">ODS数据原始层设计</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-09 19:18:10 / 修改时间：21:45:57" itemprop="dateCreated datePublished" datetime="2020-03-09T19:18:10+08:00">2020-03-09</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据项目开发/" itemprop="url" rel="index"><span itemprop="name">大数据项目开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据仓库分层设计"><a href="#数据仓库分层设计" class="headerlink" title="数据仓库分层设计"></a>数据仓库分层设计</h1>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2020/03/09/ODS数据原始层设计/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/08/智慧出行1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/08/智慧出行1/" class="post-title-link" itemprop="url">智慧出行1</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-08 14:00:50 / 修改时间：14:26:10" itemprop="dateCreated datePublished" datetime="2020-03-08T14:00:50+08:00">2020-03-08</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据开发/" itemprop="url" rel="index"><span itemprop="name">大数据开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h1><p>​        随着人们对出行的需求日益增加，出行的安全问题，出行的便捷问题等问题日益突出，特别是安全出行是我们每个人都迫切需要的，为了增加出行的便捷，提高出行的安全，对我们乘车的细节以及发生点我们迫切的需要及时知道，为此特地通过大数据的手段来处理我们海量的出行数据，做到订单的实时监控，乘车轨迹的的细节回放，虚拟车站的科学制定，出行迁途的细节过程，订单报表的大屏展示，以及用户乘车行为统计，用户画像等功能，实现用户的出行统计，制定用户的的“杀熟”策略等。</p>
<h1 id="项目需求及技术架构选型"><a href="#项目需求及技术架构选型" class="headerlink" title="项目需求及技术架构选型"></a>项目需求及技术架构选型</h1><p>​        数据主要分为两部分：第一部分为日志数据，主要是司机端APP每隔一定时间上报经纬度坐标信息，以日志数据的形式进行打印到日志服务器。第二部分数据为业务库数据，主要是存储在mysql，通过分库的形式将各个不同城市的数据存储在不同的业务库里面</p>
<p><img src="/2020/03/08/智慧出行1/1583647852954.png" alt="1583647852954"></p>
<h2 id="数据采集功能技术选型"><a href="#数据采集功能技术选型" class="headerlink" title="数据采集功能技术选型"></a>数据采集功能技术选型</h2><p>数据采集框架很多，包括sqoop,datax,flume,logstash,maxwell,canal等各种数据采集框架适用场景不同，功能描述如以下表格</p>
<p><img src="/2020/03/08/智慧出行1/1583647961200.png" alt="1583647961200"></p>
<h2 id="消息中间件的技术选型"><a href="#消息中间件的技术选型" class="headerlink" title="消息中间件的技术选型"></a>消息中间件的技术选型</h2><p>市面上成熟的消息中间件技术框架也有很多，主要有以下各种消息中间件</p>
<p><img src="/2020/03/08/智慧出行1/1583648026386.png" alt="1583648026386"></p>
<h2 id="实时流式处理技术选型"><a href="#实时流式处理技术选型" class="headerlink" title="实时流式处理技术选型"></a>实时流式处理技术选型</h2><p>流式处理技术已经非常成熟，且各大框架都有提供很多种选择，以下是各种流式处理技术选型技术对比</p>
<p><img src="/2020/03/08/智慧出行1/1583648093912.png" alt="1583648093912"></p>
<h2 id="数据永久存储技术框架选型"><a href="#数据永久存储技术框架选型" class="headerlink" title="数据永久存储技术框架选型"></a>数据永久存储技术框架选型</h2><p>数据永久存储框架也有很多，比较常见的例如Hbase，kudu，HDFS等</p>
<p><img src="/2020/03/08/智慧出行1/1583648154068.png" alt="1583648154068"></p>
<h2 id="数据离线计算框架技术选型"><a href="#数据离线计算框架技术选型" class="headerlink" title="数据离线计算框架技术选型"></a>数据离线计算框架技术选型</h2><p>离线统计的框架也非常多，主要就是基于各种OLAP场景的应用计算</p>
<table>
<thead>
<tr>
<th>框架名称</th>
<th>基本介绍</th>
</tr>
</thead>
<tbody><tr>
<td>MapReduce</td>
<td>最早期的分布式文件计算系统</td>
</tr>
<tr>
<td>hive</td>
<td>基于MR的数据仓库工具</td>
</tr>
<tr>
<td>impala</td>
<td>号称当前大数据领域最快的sql  on hadoop框架，内存消耗特别大</td>
</tr>
<tr>
<td>SparkSQL</td>
<td>基于spark，一站式解决批流处理问题</td>
</tr>
<tr>
<td>FlinkSQL</td>
<td>基于flink，一站式解决批流处理问题</td>
</tr>
<tr>
<td>druid</td>
<td>针对时间序列数据提供低延迟的数据写入以及快速交互式查询的分布式OLAP数据库</td>
</tr>
<tr>
<td>kylin</td>
<td>基于Hbase实现的预计算</td>
</tr>
<tr>
<td>presto</td>
<td>分布式SQL查询引擎，用于查询分布在一个或多个不同数据源中的大数据集</td>
</tr>
<tr>
<td>clickHouse</td>
<td>俄罗斯开源提供的一个OLAP分析框架</td>
</tr>
</tbody></table>
<h1 id="日志格式说明"><a href="#日志格式说明" class="headerlink" title="日志格式说明"></a>日志格式说明</h1><p>现在主要用到成都数据以及海口数据，针对成都以及海口数据字段说明如下</p>
<h2 id="成都轨迹数据"><a href="#成都轨迹数据" class="headerlink" title="成都轨迹数据"></a>成都轨迹数据</h2><p>成都轨迹数据格式说明：一共5个字段，字段之间使用逗号隔开</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>名称</th>
<th>类型</th>
<th>示例</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>DRIVERID</td>
<td>司机ID</td>
<td>String</td>
<td>glox.jrrlltBMvCh8nxqktdr2dtopmlH</td>
<td>已经脱敏处理</td>
</tr>
<tr>
<td>ORDERID</td>
<td>订单ID</td>
<td>String</td>
<td>jkkt8kxniovIFuns9qrrlvst@iqnpkwz</td>
<td>已经脱敏处理</td>
</tr>
<tr>
<td>TIME</td>
<td>时间戳</td>
<td>String</td>
<td>1501584540</td>
<td>unix时间戳，单位为秒</td>
</tr>
<tr>
<td>LNG</td>
<td>经度</td>
<td>String</td>
<td>104.04392</td>
<td>GCJ-02坐标系</td>
</tr>
<tr>
<td>LAT</td>
<td>纬度</td>
<td>String</td>
<td>30.67518</td>
<td>GCJ-02坐标系</td>
</tr>
</tbody></table>
<p>注意：上区域的中所体现的OD数据是相比全城是很小的量，不能反映全城的供需情况目前得到的轨迹数据中可以看到时间不是按照递增的方式进行排列，<strong>在进行数据处理时需要先对数据按照时间进行升序排列(轨迹点的产生的时间是递增的，从时间的角度才能看出轨迹的运行规律),排序后便于在地图上进行轨迹的呈现</strong>。</p>
<h2 id="海口订单数据"><a href="#海口订单数据" class="headerlink" title="海口订单数据"></a>海口订单数据</h2><p>海口订单数据一共24个字段，字段之间使用\t制表符分开，字段详情参见下表</p>
<table>
<thead>
<tr>
<th>字段ID</th>
<th>字段名称</th>
<th>字段样本描述</th>
</tr>
</thead>
<tbody><tr>
<td>order_id</td>
<td>订单ID</td>
<td>string类型且已脱敏</td>
</tr>
<tr>
<td>product_id</td>
<td>产品线ID</td>
<td>1滴滴专车， 2滴滴企业专车， 3滴滴快车， 4滴滴企业快车</td>
</tr>
<tr>
<td>city_id</td>
<td>城市ID</td>
<td>选取海口当地</td>
</tr>
<tr>
<td>district</td>
<td>城市区号</td>
<td>海口区号</td>
</tr>
<tr>
<td>county</td>
<td>二级区县</td>
<td>记录区县id</td>
</tr>
<tr>
<td>type</td>
<td>订单时效</td>
<td>0实时，1预约</td>
</tr>
<tr>
<td>combo_type</td>
<td>订单类型</td>
<td>1包车，4拼车</td>
</tr>
<tr>
<td>traffic_type</td>
<td>交通类型</td>
<td>1企业时租，2企业接机套餐，3企业送机套餐，4拼车，5接机，6送机，302跨城拼车</td>
</tr>
<tr>
<td>passenger_count</td>
<td>乘车人数</td>
<td>拼车场景，乘客选择的乘车人数</td>
</tr>
<tr>
<td>driver_product_id</td>
<td>司机子产品线</td>
<td>司机所属产品线</td>
</tr>
<tr>
<td>start_dest_distance</td>
<td>乘客发单时出发地与终点的预估路面距离</td>
<td>乘客发单时，出发地与终点的预估路面距离</td>
</tr>
<tr>
<td>arrive_time</td>
<td>司机点击‘到达’的时间</td>
<td>司机点击‘到达目的地’的时间</td>
</tr>
<tr>
<td>departure_time</td>
<td>出发时间</td>
<td>如果是实时单，出发时间(departure_time) 与司机点击‘开始计费’的时间(begin_charge_time)含义相同；如果是预约单，是指乘客填写的出发时间</td>
</tr>
<tr>
<td>pre_total_fee</td>
<td>预估价格</td>
<td>根据用户输入的起始点和目的地预估价格</td>
</tr>
<tr>
<td>normal_time</td>
<td>时长</td>
<td>分钟</td>
</tr>
<tr>
<td>bubble_trace_id</td>
<td></td>
<td></td>
</tr>
<tr>
<td>product_1level</td>
<td>一级业务线</td>
<td>1专车，3快车，9豪华车</td>
</tr>
<tr>
<td>dest_lng</td>
<td>终点经度</td>
<td>对应乘客填写的目的地对应的经度</td>
</tr>
<tr>
<td>dest_lat</td>
<td>终点纬度</td>
<td>对应乘客填写的目的地对应的纬度</td>
</tr>
<tr>
<td>starting_lng</td>
<td>起点经度</td>
<td>对应乘客填写的起始点对应的经度</td>
</tr>
<tr>
<td>year</td>
<td>年份</td>
<td>对应出行的年份</td>
</tr>
<tr>
<td>month</td>
<td>月份</td>
<td>对应出行的月份</td>
</tr>
<tr>
<td>day</td>
<td>日期</td>
<td>对应出行的日期</td>
</tr>
</tbody></table>
<p>开放城市：海口</p>
<p>开放范围：2017年5月1日 - 2017年10月31日</p>
<p>数据内容：上述时间范围内的海口市每天订单数据，包含订单的起终点经纬度以及订单类型、出行品类、乘车人数的订单属性数据。其中所有涉及个人信息的数据都经过了匿名化处理。</p>
<ol>
<li><p>保留起终点经纬度小数点后四位，可能导致与真实环境坐标存在偏差，误差范围大概在十几米到几十米左右。</p>
</li>
<li><p>针对独门独户上下车点进行技术脱敏处理，将上下车点漂移到小区门口或街道上。</p>
</li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/06/Flume日志采集框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小鱼儿">
      <meta itemprop="description" content="肩膀有点痒，可能在长小翅膀">
      <meta itemprop="image" content="/images/fish.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只鱼的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2020/03/06/Flume日志采集框架/" class="post-title-link" itemprop="url">Flume辅助框架</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-03-06 11:33:44" itemprop="dateCreated datePublished" datetime="2020-03-06T11:33:44+08:00">2020-03-06</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-09 18:39:41" itemprop="dateModified" datetime="2020-03-09T18:39:41+08:00">2020-03-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据开发/" itemprop="url" rel="index"><span itemprop="name">大数据开发</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Flume日志采集框架"><a href="#Flume日志采集框架" class="headerlink" title="Flume日志采集框架"></a>Flume日志采集框架</h1><h3 id="1-Flume是什么"><a href="#1-Flume是什么" class="headerlink" title="1. Flume是什么"></a>1. Flume是什么</h3><p><img src="/2020/03/06/Flume日志采集框架/1566778379044.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在一个完整的离线大数据处理系统中，除了hdfs+mapreduce+hive组成分析系统的核心之外，还需要数据采集、结果数据导出、任务调度等不可或缺的辅助系统，而这些辅助工具在hadoop生态体系中都有便捷的开源框架。</span><br></pre></td></tr></table></figure>

<ul>
<li>Flume是Cloudera提供的一个高可用的，高可靠的，分布式的<strong>海量日志采集、聚合和传输的系统</strong></li>
<li>Flume支持在日志系统中定制各类数据发送方，用于收集数据；</li>
<li>Flume提供对数据进行简单处理，并写到各种数据接受方（可定制）的能力。</li>
</ul>
<h3 id="2-Flume的架构"><a href="#2-Flume的架构" class="headerlink" title="2. Flume的架构"></a>2. Flume的架构</h3><p><img src="/2020/03/06/Flume日志采集框架/flume.png" alt></p>
<ul>
<li>Flume 的核心是把数据从数据源收集过来，再送到目的地。为了保证输送一定成功，在送到目的地之前，会先缓存数据，待数据真正到达目的地后，删除自己缓存的数据。</li>
<li>Flume分布式系统中<strong>最核心的角色是agent</strong>，flume采集系统就是由一个个agent所连接起来形成。</li>
<li><strong>每一个agent相当于一个数据传递员，内部有三个组件</strong><ul>
<li><strong>source</strong><ul>
<li>采集组件，用于跟数据源对接，以获取数据</li>
</ul>
</li>
<li><strong>channel</strong><ul>
<li>传输通道组件，缓存数据，用于从source将数据传递到sink</li>
</ul>
</li>
<li><strong>sink</strong><ul>
<li>下沉组件，数据发送给最终存储系统或者下一级agent中</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="3-Flume采集系统结构图"><a href="#3-Flume采集系统结构图" class="headerlink" title="3. Flume采集系统结构图"></a>3. Flume采集系统结构图</h3><h4 id="3-1-简单结构"><a href="#3-1-简单结构" class="headerlink" title="3.1 简单结构"></a>3.1 简单结构</h4><ul>
<li>单个agent采集数据</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/flume.png" alt></p>
<h4 id="3-2-复杂结构"><a href="#3-2-复杂结构" class="headerlink" title="3.2 复杂结构"></a>3.2 复杂结构</h4><ul>
<li>2个agent串联</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/UserGuide_image03.png" alt></p>
<ul>
<li>多个agent串联</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/UserGuide_image02.png" alt></p>
<ul>
<li>多个channel</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/UserGuide_image04.png" alt></p>
<h3 id="4-Flume安装部署"><a href="#4-Flume安装部署" class="headerlink" title="4. Flume安装部署"></a>4. Flume安装部署</h3><p>Flume安装很简单，解压好基本上就可以使用</p>
<ul>
<li><p>1、下载安装包</p>
<ul>
<li><a href="http://archive.cloudera.com/cdh5/cdh/5/flume-ng-1.6.0-cdh5.14.2.tar.gz" target="_blank" rel="noopener">http://archive.cloudera.com/cdh5/cdh/5/flume-ng-1.6.0-cdh5.14.2.tar.gz</a></li>
<li>flume-ng-1.6.0-cdh5.14.2.tar.gz</li>
</ul>
</li>
<li><p>2、规划安装目录</p>
<ul>
<li>/install</li>
</ul>
</li>
<li><p>3、上传安装包到服务器</p>
</li>
<li><p>4、解压安装包到指定的规划目录</p>
<ul>
<li>tar -zxvf flume-ng-1.6.0-cdh5.14.2.tar.gz -C /install</li>
</ul>
</li>
<li><p>5、重命名解压目录</p>
<ul>
<li>mv apache-flume-1.6.0-cdh5.14.2-bin  flume-1.6.0-cdh5.14.2</li>
</ul>
</li>
<li><p>6、修改配置</p>
<ul>
<li><p>进入到flume安装目录下的conf文件夹中</p>
<ul>
<li><p>先重命名文件</p>
<ul>
<li>mv flume-env.sh.template flume-env.sh</li>
</ul>
</li>
<li><p>修改文件，添加java环境变量</p>
<ul>
<li>vim flume-env.sh</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/kkb/install/jdk1.8.0_141</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="5-Flume实战"><a href="#5-Flume实战" class="headerlink" title="5. Flume实战"></a>5. Flume实战</h3><h4 id="5-1-采集文件到控制台"><a href="#5-1-采集文件到控制台" class="headerlink" title="5.1 采集文件到控制台"></a>5.1 采集文件到控制台</h4><ul>
<li><p>1、需求描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">监控一个文件如果有新增的内容就把数据采集之后打印控制台，通常用于测试/调试目的</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、<strong>flume配置文件开发</strong></p>
<ul>
<li><p>在flume的安装目录下创建一个文件夹myconf， 后期存放flume开发的配置文件</p>
<ul>
<li>mkdir /install/flume-1.6.0-cdh5.14.2/myconf</li>
</ul>
</li>
<li><p>vim tail-memory-logger.conf</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">#定义一个agent，分别指定source、channel、sink别名</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置source</span><br><span class="line">#指定source的类型为exec，通过Unix命令来传输结果数据</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">#监控一个文件，有新的数据产生就不断采集走</span><br><span class="line">a1.sources.r1.command = tail -F /install/flumeData/tail.log</span><br><span class="line">#指定source的数据流入的channel中</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">#指定channel的类型为memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">#指定channel的最多可以存放数据的容量</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">#指定在一个事务中source写数据到channel或者sink从channel取数据最大条数</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">#类型是日志格式，结果会打印在控制台</span><br><span class="line">a1.sinks.k1.type = logger</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>3、启动agent</strong></p>
<ul>
<li>进入到node01上的/install/flume-1.6.0-cdh5.14.2目录下执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/tail-memory-logger.conf -</span><br><span class="line">Dflume.root.logger=info,console</span><br><span class="line"></span><br><span class="line">其中：</span><br><span class="line">-n[name]表示指定该agent名称</span><br><span class="line">-c[myconf]表示配置文件所在的目录</span><br><span class="line">-f表示配置文件的路径名称</span><br><span class="line">-D表示指定key=value键值对---这里指定的是启动的日志输出级别</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="5-2-采集文件到HDFS"><a href="#5-2-采集文件到HDFS" class="headerlink" title="5.2 采集文件到HDFS"></a>5.2 采集文件到HDFS</h4><ul>
<li><p>1、需求描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">监控一个文件如果有新增的内容就把数据采集到HDFS上</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、结构示意图</p>
</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/file-Flume-HDFS.png" alt></p>
<ul>
<li><p><strong>3、flume配置文件开发</strong></p>
<ul>
<li>vim file2Hdfs.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置source</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /install/flumeData/tail.log</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">a1.channels.c1.type = file</span><br><span class="line">#设置检查点目录--该目录是记录下event在数据目录下的位置</span><br><span class="line">a1.channels.c1.checkpointDir=/data/flume_checkpoint</span><br><span class="line">#数据存储所在的目录</span><br><span class="line">a1.channels.c1.dataDirs=/data/flume_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">#指定sink类型为hdfs</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">#指定数据收集到hdfs目录</span><br><span class="line">a1.sinks.k1.hdfs.path = hdfs://node01:8020/tailFile/%Y-%m-%d/%H%M</span><br><span class="line">#指定生成文件名的前缀</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = events-</span><br><span class="line"></span><br><span class="line">#是否启用时间上的”舍弃”   --&gt;控制目录 </span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">#时间上进行“舍弃”的值</span><br><span class="line"># 如 12:10 -- 12:19 =&gt; 12:10</span><br><span class="line"># 如 12:20 -- 12:29 =&gt; 12:20</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">#时间上进行“舍弃”的单位</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line"></span><br><span class="line"># 控制文件个数</span><br><span class="line">#60s或者50字节或者10条数据，谁先满足，就开始滚动生成新文件</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 60</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 50</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 10</span><br><span class="line"></span><br><span class="line">#每个批次写入的数据量</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 100</span><br><span class="line"></span><br><span class="line">#开始本地时间戳--开启后就可以使用%Y-%m-%d去解析时间</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line"></span><br><span class="line">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>4、启动agent</strong></p>
<ul>
<li><p>进入到node01上的/install/flume-1.6.0-cdh5.14.2目录下执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/file2Hdfs.conf -Dflume.root.logger=info,consol</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="5-3-采集目录到HDFS"><a href="#5-3-采集目录到HDFS" class="headerlink" title="5.3 采集目录到HDFS"></a>5.3 采集目录到HDFS</h4><ul>
<li><p>1、需求描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个目录中不断有新的文件产生，需要把目录中的文件不断地进行数据收集保存到HDFS上</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、结构示意图</p>
<p><img src="/2020/03/06/Flume日志采集框架/Dir-Flume-HDFS.png" alt></p>
</li>
<li><p><strong>3、flume配置文件开发</strong></p>
<ul>
<li>在myconf目录中创建配置文件添加内容<ul>
<li>vim  dir2Hdfs.conf</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># 配置source</span><br><span class="line">##注意：不能往监控目中重复丢同名文件</span><br><span class="line">a1.sources.r1.type = spooldir</span><br><span class="line">a1.sources.r1.spoolDir = /install/flumeData/files</span><br><span class="line"># 是否将文件的绝对路径添加到header</span><br><span class="line">a1.sources.r1.fileHeader = true</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.hdfs.path = hdfs://node01:9000/spooldir/%Y-%m-%d/%H%M</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = events-</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 60</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 50</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 10</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 100</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>4、启动agent</strong></p>
</li>
<li><p>进入到node01上的/install/flume-1.6.0-cdh5.14.2目录下执行</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/dir2Hdfs.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<h4 id="5-4-两个agent级联"><a href="#5-4-两个agent级联" class="headerlink" title="5.4 两个agent级联"></a>5.4 两个agent级联</h4><ul>
<li>1、需求描述</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">第一个agent负责监控某个目录中新增的文件进行数据收集，通过网络发送到第二个agent当中去，第二个agent负责接收第一个agent发送的数据，并将数据保存到hdfs上面去。</span><br></pre></td></tr></table></figure>

<ul>
<li>2、结构示意图</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/Dir-Flume-HDFS.png" alt></p>
<ul>
<li><p>3、在node01和node02上分别都安装flume</p>
</li>
<li><p>4、创建node01上的flume配置文件</p>
<ul>
<li>vim dir2avro.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># 配置source</span><br><span class="line">##注意：不能往监控目中重复丢同名文件</span><br><span class="line">a1.sources.r1.type = spooldir</span><br><span class="line">a1.sources.r1.spoolDir = /install/flumeData/files</span><br><span class="line">a1.sources.r1.fileHeader = true</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">#AvroSink是用来通过网络来传输数据的,可以将event发送到RPC服务器(比如AvroSource)</span><br><span class="line">a1.sinks.k1.type = avro</span><br><span class="line"></span><br><span class="line">#node02 注意修改为自己的hostname</span><br><span class="line">a1.sinks.k1.hostname = node02</span><br><span class="line">a1.sinks.k1.port = 4141</span><br></pre></td></tr></table></figure>
</li>
<li><p>5、创建node02上的flume配置文件</p>
<ul>
<li>vim avro2Hdfs.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置source</span><br><span class="line">#通过AvroSource接受AvroSink的网络数据</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">#AvroSource服务的ip地址</span><br><span class="line">a1.sources.r1.bind = node02</span><br><span class="line">#AvroSource服务的端口</span><br><span class="line">a1.sources.r1.port = 4141</span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path = hdfs://node01:9000/avro-hdfs/%Y-%m-%d/%H-%M</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = events-</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 60</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 50</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 10</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 100</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>6、启动agent</strong></p>
<ul>
<li><p>先启动node02上的flume。然后在启动node01上的flume</p>
<ul>
<li>在node02上的flume安装目录下执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/avro2Hdfs.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>在node01上的flume安装目录下执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/dir2avro.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在node01上的/kkb/install/flumeData/files目录下创建一些数据文件，最后去HDFS上查看数据。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="6-高可用配置案例"><a href="#6-高可用配置案例" class="headerlink" title="6. 高可用配置案例"></a>6. 高可用配置案例</h3><h4 id="6-1-failover故障转移"><a href="#6-1-failover故障转移" class="headerlink" title="6.1 failover故障转移"></a>6.1 failover故障转移</h4><p><img src="/2020/03/06/Flume日志采集框架/flume-failover.png" alt></p>
<ul>
<li>1、节点分配</li>
</ul>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">服务器主机名</th>
<th align="center">ip地址</th>
<th align="center">角色</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Agent1</td>
<td align="center">node01</td>
<td align="center">192.168.200.200</td>
<td align="center">WebServer</td>
</tr>
<tr>
<td align="center">Collector1</td>
<td align="center">node02</td>
<td align="center">192.168.200.210</td>
<td align="center">AgentMstr1</td>
</tr>
<tr>
<td align="center">Collector2</td>
<td align="center">node03</td>
<td align="center">192.168.200.220</td>
<td align="center">AgentMstr2</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Agent1数据分别流入到Collector1和Collector2，Flume NG本身提供了Failover机制，可以自动切换和恢复。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>2、开发配置文件</p>
<ul>
<li><p>node01、node02、node03分别都要安装flume</p>
</li>
<li><p>创建node01上的flume配置文件</p>
<ul>
<li>vim flume-client-failover.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#agent name</span><br><span class="line">a1.channels = c1</span><br><span class="line">a1.sources = r1</span><br><span class="line">#定义了2个sink</span><br><span class="line">a1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set gruop</span><br><span class="line">#设置一个sink组，一个sink组下可以包含很多个sink</span><br><span class="line">a1.sinkgroups = g1</span><br><span class="line"></span><br><span class="line">#set sink group</span><br><span class="line">#指定g1这个sink组下有k1  k2 这2个sink</span><br><span class="line">a1.sinkgroups.g1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set source</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /install/flumeData/tail.log</span><br><span class="line"></span><br><span class="line">#set channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># set sink1    指定sink1的数据会传输给node02</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.type = avro</span><br><span class="line">a1.sinks.k1.hostname = node02</span><br><span class="line">a1.sinks.k1.port = 52020</span><br><span class="line"></span><br><span class="line"># set sink2    指定sink2的数据会传输给node03</span><br><span class="line">a1.sinks.k2.channel = c1</span><br><span class="line">a1.sinks.k2.type = avro</span><br><span class="line">a1.sinks.k2.hostname = node03</span><br><span class="line">a1.sinks.k2.port = 52020</span><br><span class="line"></span><br><span class="line">#set failover</span><br><span class="line">#指定sink组高可用的策略---failover故障转移</span><br><span class="line">a1.sinkgroups.g1.processor.type = failover</span><br><span class="line">#指定k1这个sink的优先级</span><br><span class="line">a1.sinkgroups.g1.processor.priority.k1 = 10</span><br><span class="line">#指定k2这个sink的优先级</span><br><span class="line">a1.sinkgroups.g1.processor.priority.k2 = 5</span><br><span class="line">#指定故障转移的最大时间，如果超时会出现异常</span><br><span class="line">a1.sinkgroups.g1.processor.maxpenalty = 10000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">#这里首先要申明一个sinkgroups,然后再设置2个sink ,k1与k2,其中2个优先级是10和5。</span><br><span class="line">#而processor的maxpenalty被设置为10秒，默认是30秒.表示故障转移的最大时间</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建node02和node03上的flume配置文件</p>
<ul>
<li>node02和node03上配置信息相同</li>
<li>vim flume-server-failover.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#set Agent name</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.channels = c1</span><br><span class="line">a1.sinks = k1</span><br><span class="line"></span><br><span class="line">#set channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># set source</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.bind = 0.0.0.0</span><br><span class="line">a1.sources.r1.port = 52020</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置拦截器</span><br><span class="line">#指定2个拦截器  i1  i2 </span><br><span class="line">a1.sources.r1.interceptors = i1 i2</span><br><span class="line">#i1的类型为时间戳拦截器  可以解析%Y-%m-%d 时间</span><br><span class="line">a1.sources.r1.interceptors.i1.type = timestamp</span><br><span class="line">#i2的类型为主机拦截器，可以获取当前event中携带的主机名</span><br><span class="line">a1.sources.r1.interceptors.i2.type = host</span><br><span class="line">#指定主机名变量</span><br><span class="line">a1.sources.r1.interceptors.i2.hostHeader=hostname</span><br><span class="line"></span><br><span class="line">#set sink to hdfs</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.type=hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path=hdfs://node01:8020/failover/logs/%&#123;hostname&#125;</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix=%Y-%m-%d</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 60</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 50</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 10</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 100</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>3、启动flume配置</p>
<ul>
<li>先分别在node02和node03上启动flume<ul>
<li>分别进入到flume的安装目录下执行命令</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/flume-server-failover.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在node01上启动flume</p>
<ul>
<li>进入到flume的安装目录下执行命令</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/flume-client-failover.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在hdfs目录上观察数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs://node01:8020/failover/logs</span><br></pre></td></tr></table></figure>

<h4 id="6-2-load-balance负载均衡"><a href="#6-2-load-balance负载均衡" class="headerlink" title="6.2 load balance负载均衡"></a>6.2 load balance负载均衡</h4><ul>
<li><p>实现多个flume采集数据的时候避免单个flume的负载比较高，实现多个flume采集器负载均衡。</p>
</li>
<li><p>1、节点分配</p>
<ul>
<li>与failover故障转移的节点分配</li>
</ul>
</li>
<li><p>2、开发配置文件</p>
<ul>
<li><p><strong>创建node01上的flume配置文件</strong></p>
<ul>
<li>vim  flume-client-loadbalance.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#agent name</span><br><span class="line">a1.channels = c1</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set gruop</span><br><span class="line">a1.sinkgroups = g1</span><br><span class="line"></span><br><span class="line">#set sink group</span><br><span class="line">a1.sinkgroups.g1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set source</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /install/flumeData/tail.log</span><br><span class="line"></span><br><span class="line">#set channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># set sink1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.type = avro</span><br><span class="line">a1.sinks.k1.hostname = node02</span><br><span class="line">a1.sinks.k1.port = 52020</span><br><span class="line"></span><br><span class="line"># set sink2</span><br><span class="line">a1.sinks.k2.channel = c1</span><br><span class="line">a1.sinks.k2.type = avro</span><br><span class="line">a1.sinks.k2.hostname = node03</span><br><span class="line">a1.sinks.k2.port = 52020</span><br><span class="line"></span><br><span class="line">#set load-balance</span><br><span class="line">#指定sink组高可用的策略---load_balance负载均衡</span><br><span class="line">a1.sinkgroups.g1.processor.type =load_balance</span><br><span class="line"># 默认是round_robin，还可以选择random</span><br><span class="line">a1.sinkgroups.g1.processor.selector = round_robin</span><br><span class="line">#如果backoff被开启，则sink processor会屏蔽故障的sink</span><br><span class="line">a1.sinkgroups.g1.processor.backoff = true</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>创建node02和node03上的flume配置文件</strong></p>
<ul>
<li>vim  flume-server-loadbalance.conf</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#set Agent name</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.channels = c1</span><br><span class="line">a1.sinks = k1</span><br><span class="line"></span><br><span class="line">#set channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># set source</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.bind = 0.0.0.0</span><br><span class="line">a1.sources.r1.port = 52020</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置拦截器</span><br><span class="line">a1.sources.r1.interceptors = i1 i2</span><br><span class="line">a1.sources.r1.interceptors.i1.type = timestamp</span><br><span class="line">a1.sources.r1.interceptors.i2.type = host</span><br><span class="line">a1.sources.r1.interceptors.i2.hostHeader=hostname</span><br><span class="line">#hostname不使用ip显示，直接就是该服务器对应的主机名</span><br><span class="line">a1.sources.r1.interceptors.i2.useIP=false</span><br><span class="line"></span><br><span class="line">#set sink to hdfs</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.type=hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path=hdfs://node01:8020/loadbalance/logs/%&#123;hostname&#125;</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix=%Y-%m-%d</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 60</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 50</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 10</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 100</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br></pre></td></tr></table></figure>

<ul>
<li><p>3、启动flume配置</p>
<ul>
<li>先分别在node02和node03上启动flume<ul>
<li>分别进入到flume的安装目录下执行命令</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/flume-server-loadbalance.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在node01上启动flume</p>
<ul>
<li>分别进入到flume的安装目录下执行命令</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/flume-client-loadbalance.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在hdfs上目录观察数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs://node01:8020/loadbalance/logs</span><br></pre></td></tr></table></figure>

<h3 id="7-flume企业案例"><a href="#7-flume企业案例" class="headerlink" title="7. flume企业案例"></a>7. flume企业案例</h3><h4 id="7-1-flume案例之静态拦截器使用"><a href="#7-1-flume案例之静态拦截器使用" class="headerlink" title="7.1 flume案例之静态拦截器使用"></a>7.1 flume案例之静态拦截器使用</h4><ul>
<li>1、案例场景</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A、B两台日志服务机器实时生产日志主要类型为access.log、nginx.log、web.log </span><br><span class="line">现在需要把A、B 机器中的access.log、nginx.log、web.log 采集汇总到C机器上然后统一收集到hdfs中。</span><br><span class="line">但是在hdfs中要求的目录为：</span><br><span class="line">/source/logs/access/20180101/**</span><br><span class="line">/source/logs/nginx/20180101/**</span><br><span class="line">/source/logs/web/20180101/**</span><br></pre></td></tr></table></figure>

<ul>
<li>2、场景分析</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%AC%E5%9B%9B%E6%9C%9F/9_%E8%BE%85%E5%8A%A9%E6%A1%86%E6%9E%B6/1227-%E8%AF%BE%E5%89%8D%E8%B5%84%E6%96%99%E6%9B%B4%E6%96%B0-flume/1227-%E8%AF%BE%E5%89%8D%E8%B5%84%E6%96%99-flume/flume/Flume%E8%AF%BE%E7%A8%8B/Flume%E8%AF%BE%E7%A8%8B/Flume%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E6%A1%86%E6%9E%B6.assets/flume%E9%87%87%E9%9B%86%E4%B8%8D%E5%90%8C%E7%9A%84%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE.png" alt="flume采集不同的日志数据"></p>
<ul>
<li>3、数据流程处理分析</li>
</ul>
<p><img src="/2020/03/06/Flume日志采集框架/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%AC%E5%9B%9B%E6%9C%9F/9_%E8%BE%85%E5%8A%A9%E6%A1%86%E6%9E%B6/1227-%E8%AF%BE%E5%89%8D%E8%B5%84%E6%96%99%E6%9B%B4%E6%96%B0-flume/1227-%E8%AF%BE%E5%89%8D%E8%B5%84%E6%96%99-flume/flume/Flume%E8%AF%BE%E7%A8%8B/Flume%E8%AF%BE%E7%A8%8B/Flume%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E6%A1%86%E6%9E%B6.assets/flume%E9%87%87%E9%9B%86%E4%B8%8D%E5%90%8C%E7%9A%84%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90.png" alt></p>
<ul>
<li><p>4、开发配置文件</p>
<ul>
<li><p>==在node01与node02服务器开发flume的配置文件==</p>
<ul>
<li>vim exec_source_avro_sink.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">#定义三个source</span><br><span class="line">a1.sources = r1 r2 r3</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /home/hadoop/taillogs/access.log</span><br><span class="line">#指定source r1 使用拦截器i1</span><br><span class="line">a1.sources.r1.interceptors = i1</span><br><span class="line">#拦截器类型static静态</span><br><span class="line">a1.sources.r1.interceptors.i1.type = static</span><br><span class="line">## static拦截器的功能就是往采集到的数据的header中插入自己定义的key-value对</span><br><span class="line"># 自己进行设置,我们这里的key和value相当于键值对,k=type v=access</span><br><span class="line">a1.sources.r1.interceptors.i1.key = type</span><br><span class="line">a1.sources.r1.interceptors.i1.value = access</span><br><span class="line"></span><br><span class="line">a1.sources.r2.type = exec</span><br><span class="line">a1.sources.r2.command = tail -F /home/hadoop/taillogs/nginx.log</span><br><span class="line">#指定source r2 使用拦截器i2</span><br><span class="line">a1.sources.r2.interceptors = i2</span><br><span class="line">#拦截器类型static静态</span><br><span class="line">a1.sources.r2.interceptors.i2.type = static</span><br><span class="line"># 自己进行设置</span><br><span class="line">a1.sources.r2.interceptors.i2.key = type</span><br><span class="line">a1.sources.r2.interceptors.i2.value = nginx</span><br><span class="line"></span><br><span class="line">a1.sources.r3.type = exec</span><br><span class="line">a1.sources.r3.command = tail -F /home/hadoop/taillogs/web.log</span><br><span class="line">#指定source r3 使用拦截器i3</span><br><span class="line">a1.sources.r3.interceptors = i3</span><br><span class="line">#拦截器类型static静态</span><br><span class="line">a1.sources.r3.interceptors.i3.type = static</span><br><span class="line"># 自己进行设置</span><br><span class="line">a1.sources.r3.interceptors.i3.key = type</span><br><span class="line">a1.sources.r3.interceptors.i3.value = web</span><br><span class="line"></span><br><span class="line"># Use a channel which buffers events in memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 20000</span><br><span class="line">a1.channels.c1.transactionCapacity = 10000</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = avro</span><br><span class="line">a1.sinks.k1.hostname = node03</span><br><span class="line">a1.sinks.k1.port = 41414</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r2.channels = c1</span><br><span class="line">a1.sources.r3.channels = c1</span><br></pre></td></tr></table></figure>
</li>
<li><p>==在node03服务器上开发flume配置文件==</p>
<ul>
<li>vim avro_source_hdfs_sink.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line">#定义source</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.bind = node03</span><br><span class="line">a1.sources.r1.port =41414</span><br><span class="line"></span><br><span class="line">#定义channels</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 20000</span><br><span class="line">a1.channels.c1.transactionCapacity = 1000</span><br><span class="line"></span><br><span class="line">#定义sink</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line"># 此处的%&#123;type&#125; 这里是取我们在node01和node02定义的type的值,也就是value</span><br><span class="line">a1.sinks.k1.hdfs.path=hdfs://node01:9000/source/logs/%&#123;type&#125;/%Y%m%d</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix =events-</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line">a1.sinks.k1.hdfs.writeFormat = Text</span><br><span class="line">#时间类型</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件不按条数生成</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 0</span><br><span class="line">#生成的文件按时间生成</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 30</span><br><span class="line">#生成的文件按大小生成</span><br><span class="line">a1.sinks.k1.hdfs.rollSize  = 10485760</span><br><span class="line">#批量写入hdfs的个数</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 1000</span><br><span class="line">#flume操作hdfs的线程数（包括新建，写入等）</span><br><span class="line">a1.sinks.k1.hdfs.threadsPoolSize=10</span><br><span class="line">#操作hdfs超时时间</span><br><span class="line">a1.sinks.k1.hdfs.callTimeout=30000</span><br><span class="line"></span><br><span class="line">#组装source、channel、sink</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>5、启动flume配置</p>
<ul>
<li>先在node03上启动flume</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/avro_source_hdfs_sink.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>然后分别在node01和node02上启动flume</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/exec_source_avro_sink.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在node01和node02上准备数据文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/home/hadoop/taillogs/access.log</span><br><span class="line">/home/hadoop/taillogs/nginx.log</span><br><span class="line">/home/hadoop/taillogs/web.log</span><br><span class="line"></span><br><span class="line">创建以上文件，内容是什么不重要</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后在hdfs上对应的目录观察</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs://node01:8020/source/logs</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="7-2-flume案例之自定义拦截器"><a href="#7-2-flume案例之自定义拦截器" class="headerlink" title="7.2 flume案例之自定义拦截器"></a>7.2 flume案例之自定义拦截器</h4><ul>
<li>1、案例场景</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在数据采集之后，通过flume的拦截器，实现不需要的数据过滤掉，并将指定的第一个字段进行加密，加密之后再往hdfs上面保存</span><br></pre></td></tr></table></figure>

<ul>
<li>2、数据文件 user.txt</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">13901007610,male,30,sing,beijing</span><br><span class="line">18600000035,male,40,dance,shanghai</span><br><span class="line">13366666659,male,20,Swimming,wuhan</span><br><span class="line">13801179888,female,18,dance,tianjin</span><br><span class="line">18511111114,male,35,sing,beijing</span><br><span class="line">13718428888,female,40,Foodie,shanghai</span><br><span class="line">13901057088,male,50,Basketball,taiwan</span><br><span class="line">13671057777,male,60,Bodybuilding,xianggang</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/06/Flume日志采集框架/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%AC%E5%9B%9B%E6%9C%9F/9_%E8%BE%85%E5%8A%A9%E6%A1%86%E6%9E%B6/1227-%E8%AF%BE%E5%89%8D%E8%B5%84%E6%96%99%E6%9B%B4%E6%96%B0-flume/1227-%E8%AF%BE%E5%89%8D%E8%B5%84%E6%96%99-flume/flume/Flume%E8%AF%BE%E7%A8%8B/Flume%E8%AF%BE%E7%A8%8B/Flume%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E6%A1%86%E6%9E%B6.assets/flume-custom-interceptor.png" alt></p>
<ul>
<li>3、创建maven工程添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>cloudera<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repository.cloudera.com/artifactory/cloudera-repos/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flume<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flume-ng-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.0-cdh5.14.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--    &lt;verbal&gt;true&lt;/verbal&gt;--&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">filters</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">artifact</span>&gt;</span>*:*<span class="tag">&lt;/<span class="name">artifact</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.SF<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.DSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.RSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">filters</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span><span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>4、代码开发</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Charsets;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Event;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.interceptor.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** encrypted_field_index. 指定需要加密的字段下标 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String encrypted_field_index;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The out_index. 指定不需要对应列的下标*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String out_index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供构建方法，后期可以接受配置文件中的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encrypted_field_index</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out_index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyInterceptor</span><span class="params">( String encrypted_field_index, String out_index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.encrypted_field_index=encrypted_field_index.trim();</span><br><span class="line">        <span class="keyword">this</span>.out_index=out_index.trim();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 单个event拦截逻辑</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Event <span class="title">intercept</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String line = <span class="keyword">new</span> String(event.getBody(), Charsets.UTF_8);</span><br><span class="line">            String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">            String newLine = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">                <span class="comment">//字符串数字转换成int</span></span><br><span class="line">                <span class="keyword">int</span> encryptedField = Integer.parseInt(encrypted_field_index);</span><br><span class="line">                <span class="keyword">int</span> outIndex = Integer.parseInt(out_index);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i == encryptedField) &#123;</span><br><span class="line">                     newLine+=md5(fields[i])+<span class="string">","</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i !=outIndex) &#123;</span><br><span class="line">                    newLine+=fields[i]+<span class="string">","</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            newLine=newLine.substring(<span class="number">0</span>,newLine.length()-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">              event.setBody(newLine.getBytes(Charsets.UTF_8));</span><br><span class="line">            <span class="keyword">return</span> event;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> event;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 批量event拦截逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Event&gt; <span class="title">intercept</span><span class="params">(List&lt;Event&gt; events)</span> </span>&#123;</span><br><span class="line">        List&lt;Event&gt; out = <span class="keyword">new</span> ArrayList&lt;Event&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Event event : events) &#123;</span><br><span class="line">            Event outEvent = intercept(event);</span><br><span class="line">            <span class="keyword">if</span> (outEvent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                out.add(outEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写一个md5加密的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">md5</span><span class="params">(String plainText)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//定义一个字节数组</span></span><br><span class="line">        <span class="keyword">byte</span>[] secretBytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生成一个MD5加密计算摘要</span></span><br><span class="line">            MessageDigest md = MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">            <span class="comment">//对字符串进行加密</span></span><br><span class="line">            md.update(plainText.getBytes());</span><br><span class="line">            <span class="comment">//获得加密后的数据</span></span><br><span class="line">            secretBytes = md.digest();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"没有md5这个算法！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将加密后的数据转换为16进制数字</span></span><br><span class="line">        String md5code = <span class="keyword">new</span> BigInteger(<span class="number">1</span>, secretBytes).toString(<span class="number">16</span>);<span class="comment">// 16进制数字</span></span><br><span class="line">        <span class="comment">// 如果生成数字未满32位，需要前面补0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span> - md5code.length(); i++) &#123;</span><br><span class="line">            md5code = <span class="string">"0"</span> + md5code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> md5code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 相当于自定义Interceptor的工厂类</span></span><br><span class="line"><span class="comment">     * 在flume采集配置文件中通过制定该Builder来创建Interceptor对象</span></span><br><span class="line"><span class="comment">     * 可以在Builder中获取、解析flume采集配置文件中的拦截器Interceptor的自定义参数：</span></span><br><span class="line"><span class="comment">     * 指定需要加密的字段下标 指定不需要对应列的下标等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBuilder</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Builder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * encrypted_field_index. 指定需要加密的字段下标</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span>  String encrypted_field_index;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The out_index. 指定不需要对应列的下标</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span>  String out_index;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.encrypted_field_index = context.getString(<span class="string">"encrypted_field_index"</span>, <span class="string">""</span>);</span><br><span class="line">            <span class="keyword">this</span>.out_index = context.getString(<span class="string">"out_index"</span>, <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * @see org.apache.flume.interceptor.Interceptor.Builder#build()</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MyInterceptor <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MyInterceptor(encrypted_field_index, out_index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>5、打成jar包后放到flume安装目录下的lib中</p>
</li>
<li><p>6、创建配置文件 flume-interceptor-hdfs.conf</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置source</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /install/flumeData/user.txt</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.interceptors =i1</span><br><span class="line">a1.sources.r1.interceptors.i1.type =com.kaikeba.interceptor.MyInterceptor$MyBuilder</span><br><span class="line">a1.sources.r1.interceptors.i1.encrypted_field_index=0</span><br><span class="line">a1.sources.r1.interceptors.i1.out_index=3</span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.hdfs.path = hdfs://node01:8020/interceptor/files/%Y-%m-%d/%H%M</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = events-</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 5</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 50</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 10</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 100</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br></pre></td></tr></table></figure>

<ul>
<li>7、进入到flume安装目录下启动flume</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/flume-interceptor-hdfs.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<h3 id="8-flume自定义Source"><a href="#8-flume自定义Source" class="headerlink" title="8. flume自定义Source"></a>8. flume自定义Source</h3><h4 id="8-1-场景描述"><a href="#8-1-场景描述" class="headerlink" title="8.1 场景描述"></a>8.1 场景描述</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	官方提供的source类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些source。如：实时监控MySQL，从MySQL中获取数据传输到HDFS或者其他存储框架，所以此时需要我们自己实现MySQLSource。</span><br><span class="line"></span><br><span class="line">官方也提供了自定义source的接口：</span><br><span class="line">官网说明：https://flume.apache.org/FlumeDeveloperGuide.html#source</span><br></pre></td></tr></table></figure>

<h4 id="8-2-自定义MysqlSource步骤"><a href="#8-2-自定义MysqlSource步骤" class="headerlink" title="8.2 自定义MysqlSource步骤"></a>8.2 自定义MysqlSource步骤</h4><ul>
<li><p>1、根据官方说明自定义mysqlsource需要继承AbstractSource类并实现Configurable和PollableSource接口。</p>
</li>
<li><p>2、实现对应的方法</p>
<ul>
<li>configure(Context context)<ul>
<li>初始化context</li>
</ul>
</li>
<li>process()<ul>
<li>从mysql表中获取数据，然后把数据封装成event对象写入到channel，该方法被一直调用</li>
</ul>
</li>
<li>stop()<ul>
<li>关闭相关资源</li>
</ul>
</li>
</ul>
</li>
<li><p>3、开发流程</p>
<ul>
<li>3.1 创建mysql数据库以及mysql数据库表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建一个数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> mysqlsource <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 ;</span><br><span class="line"></span><br><span class="line"><span class="comment">--创建一个表，用户保存拉取目标表位置的信息</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysqlsource.flume_meta (</span><br><span class="line">  source_tab <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  currentIndex <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (source_tab)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">--插入数据</span></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> mysqlsource.flume_meta(source_tab,currentIndex) <span class="keyword">values</span> (<span class="string">'student'</span>,<span class="string">'4'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--创建要拉取数据的表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysqlsource.student(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">5</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">--向student表中添加测试数据</span></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> mysqlsource.student(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'zhangsan'</span>),(<span class="number">2</span>,<span class="string">'lisi'</span>),(<span class="number">3</span>,<span class="string">'wangwu'</span>),(<span class="number">4</span>,<span class="string">'zhaoliu'</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>3.2 代码开发实现</p>
<ul>
<li>构建maven工程，添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>在resources资源文件夹下添加jdbc.properties</p>
<ul>
<li>jdbc.properties</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dbDriver=com.mysql.jdbc.Driver</span><br><span class="line">dbUrl=jdbc:mysql://node03:3306/mysqlsource?useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="line">dbUser=root</span><br><span class="line">dbPassword=123456</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义QueryMysql工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.source;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.conf.ConfigurationException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryMysql</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(QueryMysql.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> runQueryDelay,   <span class="comment">//两次查询的时间间隔</span></span><br><span class="line">            startFrom,            <span class="comment">//开始id</span></span><br><span class="line">            currentIndex,	      <span class="comment">//当前id</span></span><br><span class="line">            recordSixe = <span class="number">0</span>,        <span class="comment">//每次查询返回结果的条数</span></span><br><span class="line">            maxRow;                <span class="comment">//每次查询的最大条数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String table,          <span class="comment">//要操作的表</span></span><br><span class="line">            columnsToSelect,       <span class="comment">//用户传入的查询的列</span></span><br><span class="line">            customQuery,          <span class="comment">//用户传入的查询语句</span></span><br><span class="line">            query,                 <span class="comment">//构建的查询语句</span></span><br><span class="line">            defaultCharsetResultSet;<span class="comment">//编码集</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//上下文，用来获取配置文件</span></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为定义的变量赋值（默认值），可在flume任务的配置文件中修改</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_QUERY_DELAY = <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_START_VALUE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_ROWS = <span class="number">2000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_COLUMNS_SELECT = <span class="string">"*"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CHARSET_RESULTSET = <span class="string">"UTF-8"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection conn = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String connectionURL, connectionUserName, connectionPassword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载静态资源</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p.load(QueryMysql.class.getClassLoader().getResourceAsStream(<span class="string">"jdbc.properties"</span>));</span><br><span class="line">            connectionURL = p.getProperty(<span class="string">"dbUrl"</span>);</span><br><span class="line">            connectionUserName = p.getProperty(<span class="string">"dbUser"</span>);</span><br><span class="line">            connectionPassword = p.getProperty(<span class="string">"dbPassword"</span>);</span><br><span class="line">            Class.forName(p.getProperty(<span class="string">"dbDriver"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取JDBC连接</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title">InitConnection</span><span class="params">(String url, String user, String pw)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Connection conn = DriverManager.getConnection(url, user, pw);</span><br><span class="line">            <span class="keyword">if</span> (conn == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SQLException();</span><br><span class="line">            <span class="keyword">return</span> conn;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法</span></span><br><span class="line">    QueryMysql(Context context) <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="comment">//初始化上下文</span></span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有默认值参数：获取flume任务配置文件中的参数，读不到的采用默认值</span></span><br><span class="line">        <span class="keyword">this</span>.columnsToSelect = context.getString(<span class="string">"columns.to.select"</span>, DEFAULT_COLUMNS_SELECT);</span><br><span class="line">        <span class="keyword">this</span>.runQueryDelay = context.getInteger(<span class="string">"run.query.delay"</span>, DEFAULT_QUERY_DELAY);</span><br><span class="line">        <span class="keyword">this</span>.startFrom = context.getInteger(<span class="string">"start.from"</span>, DEFAULT_START_VALUE);</span><br><span class="line">        <span class="keyword">this</span>.defaultCharsetResultSet = context.getString(<span class="string">"default.charset.resultset"</span>, DEFAULT_CHARSET_RESULTSET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//无默认值参数：获取flume任务配置文件中的参数</span></span><br><span class="line">        <span class="keyword">this</span>.table = context.getString(<span class="string">"table"</span>);</span><br><span class="line">        <span class="keyword">this</span>.customQuery = context.getString(<span class="string">"custom.query"</span>);</span><br><span class="line"></span><br><span class="line">        connectionURL = context.getString(<span class="string">"connection.url"</span>);</span><br><span class="line">        connectionUserName = context.getString(<span class="string">"connection.user"</span>);</span><br><span class="line">        connectionPassword = context.getString(<span class="string">"connection.password"</span>);</span><br><span class="line">        conn = InitConnection(connectionURL, connectionUserName, connectionPassword);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//校验相应的配置信息，如果没有默认值的参数也没赋值，抛出异常</span></span><br><span class="line">        checkMandatoryProperties();</span><br><span class="line">        <span class="comment">//获取当前的id</span></span><br><span class="line">        currentIndex = getStatusDBIndex(startFrom);</span><br><span class="line">        <span class="comment">//构建查询语句</span></span><br><span class="line">        query = buildQuery();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验相应的配置信息（表，查询语句以及数据库连接的参数）</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkMandatoryProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"property table not set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (connectionURL == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"connection.url property not set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (connectionUserName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"connection.user property not set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (connectionPassword == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"connection.password property not set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建sql语句</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">buildQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">""</span>;</span><br><span class="line">        <span class="comment">//获取当前id</span></span><br><span class="line">        currentIndex = getStatusDBIndex(startFrom);</span><br><span class="line">        LOG.info(currentIndex + <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span> (customQuery == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sql = <span class="string">"SELECT "</span> + columnsToSelect + <span class="string">" FROM "</span> + table;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sql = customQuery;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder execSql = <span class="keyword">new</span> StringBuilder(sql);</span><br><span class="line">        <span class="comment">//以id作为offset</span></span><br><span class="line">        <span class="keyword">if</span> (!sql.contains(<span class="string">"where"</span>)) &#123;</span><br><span class="line">            execSql.append(<span class="string">" where "</span>);</span><br><span class="line">            execSql.append(<span class="string">"id"</span>).append(<span class="string">"&gt;"</span>).append(currentIndex);</span><br><span class="line">            <span class="keyword">return</span> execSql.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> length = execSql.toString().length();</span><br><span class="line">            <span class="keyword">return</span> execSql.toString().substring(<span class="number">0</span>, length - String.valueOf(currentIndex).length()) + currentIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行查询</span></span><br><span class="line">    List&lt;List&lt;Object&gt;&gt; executeQuery() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//每次执行查询时都要重新生成sql，因为id不同</span></span><br><span class="line">            customQuery = buildQuery();</span><br><span class="line">            <span class="comment">//存放结果的集合</span></span><br><span class="line">            List&lt;List&lt;Object&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//初始化PrepareStatement对象</span></span><br><span class="line">                ps = conn.prepareStatement(customQuery);</span><br><span class="line">            &#125;</span><br><span class="line">            ResultSet result = ps.executeQuery(customQuery);</span><br><span class="line">            <span class="keyword">while</span> (result.next()) &#123;</span><br><span class="line">                <span class="comment">//存放一条数据的集合（多个列）</span></span><br><span class="line">                List&lt;Object&gt; row = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="comment">//将返回结果放入集合</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= result.getMetaData().getColumnCount(); i++) &#123;</span><br><span class="line">                    row.add(result.getObject(i));</span><br><span class="line">                &#125;</span><br><span class="line">                results.add(row);</span><br><span class="line">            &#125;</span><br><span class="line">            LOG.info(<span class="string">"execSql:"</span> + customQuery + <span class="string">"\nresultSize:"</span> + results.size());</span><br><span class="line">            <span class="keyword">return</span> results;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            LOG.error(e.toString());</span><br><span class="line">            <span class="comment">// 重新连接</span></span><br><span class="line">            conn = InitConnection(connectionURL, connectionUserName, connectionPassword);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将结果集转化为字符串，每一条数据是一个list集合，将每一个小的list集合转化为字符串</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">getAllRows</span><span class="params">(List&lt;List&lt;Object&gt;&gt; queryResult)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; allRows = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (queryResult == <span class="keyword">null</span> || queryResult.isEmpty())</span><br><span class="line">            <span class="keyword">return</span> allRows;</span><br><span class="line">        StringBuilder row = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (List&lt;Object&gt; rawRow : queryResult) &#123;</span><br><span class="line">            Object value = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (Object aRawRow : rawRow) &#123;</span><br><span class="line">                value = aRawRow;</span><br><span class="line">                <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    row.append(<span class="string">","</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    row.append(aRawRow.toString()).append(<span class="string">","</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            allRows.add(row.toString());</span><br><span class="line">            row = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allRows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新offset元数据状态，每次返回结果集后调用。必须记录每次查询的offset值，为程序中断续跑数据时使用，以id为offset</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateOffset2DB</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//以source_tab做为KEY，如果不存在则插入，存在则更新（每个源表对应一条记录）</span></span><br><span class="line">        String sql = <span class="string">"insert into flume_meta(source_tab,currentIndex) VALUES('"</span></span><br><span class="line">                + <span class="keyword">this</span>.table</span><br><span class="line">                + <span class="string">"','"</span> + (recordSixe += size)</span><br><span class="line">                + <span class="string">"') on DUPLICATE key update source_tab=values(source_tab),currentIndex=values(currentIndex)"</span>;</span><br><span class="line">        LOG.info(<span class="string">"updateStatus Sql:"</span> + sql);</span><br><span class="line">        execSql(sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行sql语句</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execSql</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            LOG.info(<span class="string">"exec::"</span> + sql);</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取当前id的offset</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Integer <span class="title">getStatusDBIndex</span><span class="params">(<span class="keyword">int</span> startFrom)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从flume_meta表中查询出当前的id是多少</span></span><br><span class="line">        String dbIndex = queryOne(<span class="string">"select currentIndex from flume_meta where source_tab='"</span> + table + <span class="string">"'"</span>);</span><br><span class="line">        <span class="keyword">if</span> (dbIndex != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(dbIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有数据，则说明是第一次查询或者数据表中还没有存入数据，返回最初传入的值</span></span><br><span class="line">        <span class="keyword">return</span> startFrom;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询一条数据的执行语句(当前id)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">queryOne</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">        ResultSet result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            result = ps.executeQuery();</span><br><span class="line">            <span class="keyword">while</span> (result.next()) &#123;</span><br><span class="line">                <span class="keyword">return</span> result.getString(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭相关资源</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps.close();</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCurrentIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCurrentIndex</span><span class="params">(<span class="keyword">int</span> newValue)</span> </span>&#123;</span><br><span class="line">        currentIndex = newValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getRunQueryDelay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> runQueryDelay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> query;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getConnectionURL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> connectionURL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCustomQuerySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (customQuery != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConnectionUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> connectionUserName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConnectionPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> connectionPassword;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getDefaultCharsetResultSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> defaultCharsetResultSet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义MySqlSource类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.source;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Event;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.EventDeliveryException;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.PollableSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.conf.Configurable;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.event.SimpleEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.source.AbstractSource;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlSource</span> <span class="keyword">extends</span> <span class="title">AbstractSource</span> <span class="keyword">implements</span> <span class="title">Configurable</span>, <span class="title">PollableSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打印日志</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(MySqlSource.class);</span><br><span class="line">    <span class="comment">//定义sqlHelper</span></span><br><span class="line">    <span class="keyword">private</span> QueryMysql sqlSourceHelper;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getBackOffSleepIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getMaxBackOffSleepInterval</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sqlSourceHelper = <span class="keyword">new</span> QueryMysql(context);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接受mysql表中的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> EventDeliveryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PollableSource.<span class="function">Status <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> EventDeliveryException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//查询数据表</span></span><br><span class="line">            List&lt;List&lt;Object&gt;&gt; result = sqlSourceHelper.executeQuery();</span><br><span class="line">            <span class="comment">//存放event的集合</span></span><br><span class="line">            List&lt;Event&gt; events = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="comment">//存放event头集合</span></span><br><span class="line">            HashMap&lt;String, String&gt; header = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="comment">//如果有返回数据，则将数据封装为event</span></span><br><span class="line">            <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">                List&lt;String&gt; allRows = sqlSourceHelper.getAllRows(result);</span><br><span class="line">                Event event = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (String row : allRows) &#123;</span><br><span class="line">                    event = <span class="keyword">new</span> SimpleEvent();</span><br><span class="line">                    event.setBody(row.getBytes());</span><br><span class="line">                    event.setHeaders(header);</span><br><span class="line">                    events.add(event);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//将event写入channel</span></span><br><span class="line">                <span class="keyword">this</span>.getChannelProcessor().processEventBatch(events);</span><br><span class="line">                <span class="comment">//更新数据表中的offset信息</span></span><br><span class="line">                sqlSourceHelper.updateOffset2DB(result.size());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//等待时长</span></span><br><span class="line">            Thread.sleep(sqlSourceHelper.getRunQueryDelay());</span><br><span class="line">            <span class="keyword">return</span> Status.READY;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">"Error procesing row"</span>, e);</span><br><span class="line">            <span class="keyword">return</span> Status.BACKOFF;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">"Stopping sql source &#123;&#125; ..."</span>, getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//关闭资源</span></span><br><span class="line">            sqlSourceHelper.close();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>4、测试</p>
<ul>
<li><p>4.1 程序打成jar包，上传jar包到flume的lib目录下</p>
</li>
<li><p>4.2 配置文件准备</p>
<ul>
<li>vim mysqlsource.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = com.kaikeba.source.MySqlSource</span><br><span class="line"># 老师的是node01,同学们改成自己的节点 一定要注意</span><br><span class="line">a1.sources.r1.connection.url = jdbc:mysql://node01:3306/mysqlsource</span><br><span class="line">a1.sources.r1.connection.user = root</span><br><span class="line">a1.sources.r1.connection.password = 123456</span><br><span class="line">a1.sources.r1.table = student</span><br><span class="line">a1.sources.r1.columns.to.select = *</span><br><span class="line">a1.sources.r1.start.from=0</span><br><span class="line">a1.sources.r1.run.query.delay=3000</span><br><span class="line"></span><br><span class="line"># Describe the channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>4.3 启动flume配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/mysqlsource.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>4.4 最后向表添加数据，观察控制台信息</li>
</ul>
<h3 id="9-flume自定义Sink"><a href="#9-flume自定义Sink" class="headerlink" title="9. flume自定义Sink"></a>9. flume自定义Sink</h3><h4 id="9-1-场景描述"><a href="#9-1-场景描述" class="headerlink" title="9.1 场景描述"></a>9.1 场景描述</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	官方提供的sink类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些sink。如：需要把接受到的数据按照规则进行过滤之后写入到某张mysql表中，所以此时需要我们自己实现MySQLSink。</span><br><span class="line"></span><br><span class="line">官方也提供了自定义sink的接口：</span><br><span class="line">官网说明：https://flume.apache.org/FlumeDeveloperGuide.html#sink</span><br></pre></td></tr></table></figure>

<h4 id="9-2-自定义MysqlSink步骤"><a href="#9-2-自定义MysqlSink步骤" class="headerlink" title="9.2 自定义MysqlSink步骤"></a>9.2 自定义MysqlSink步骤</h4><ul>
<li><p>1、根据官方说明自定义MysqlSink需要继承AbstractSink类并实现Configurable</p>
</li>
<li><p>2、实现对应的方法</p>
<ul>
<li><p>configure(Context context)</p>
<ul>
<li>初始化context</li>
</ul>
</li>
<li><p>start()</p>
<ul>
<li>启动准备操作</li>
</ul>
</li>
<li><p>process()</p>
<ul>
<li>从channel获取数据，然后解析之后，保存在mysql表中</li>
</ul>
</li>
<li><p>stop()</p>
<ul>
<li>关闭相关资源</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>3、开发流程</p>
<ul>
<li>3.1 创建mysql数据库以及mysql数据库表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--创建一个数据库</span><br><span class="line">CREATE DATABASE IF NOT EXISTS mysqlsource DEFAULT CHARACTER SET utf8 ;</span><br><span class="line"></span><br><span class="line">--创建一个表，用户保存拉取目标表位置的信息</span><br><span class="line">CREATE TABLE mysqlsource.flume2mysql (</span><br><span class="line">  id int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  createTime varchar(64) NOT NULL,</span><br><span class="line">  content varchar(255) NOT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>3.2  代码开发实现</p>
<p>定义MysqlSink类</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.sink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flume.conf.Configurable;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.sink.AbstractSink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义MysqlSink</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlSink</span> <span class="keyword">extends</span> <span class="title">AbstractSink</span> <span class="keyword">implements</span> <span class="title">Configurable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String mysqlurl = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">private</span> String tableName = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    Connection con = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Status <span class="title">process</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Status status = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Start transaction</span></span><br><span class="line">        Channel ch = getChannel();</span><br><span class="line">        Transaction txn = ch.getTransaction();</span><br><span class="line">        txn.begin();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            Event event = ch.take();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (event != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="comment">//获取body中的数据</span></span><br><span class="line">                    String body = <span class="keyword">new</span> String(event.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//如果日志中有以下关键字的不需要保存，过滤掉</span></span><br><span class="line">                <span class="keyword">if</span>(body.contains(<span class="string">"delete"</span>) || body.contains(<span class="string">"drop"</span>) || body.contains(<span class="string">"alert"</span>))&#123;</span><br><span class="line">                    status = Status.BACKOFF;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//存入Mysql</span></span><br><span class="line">                    SimpleDateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">                    String createtime = df.format(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">                    PreparedStatement stmt = con.prepareStatement(<span class="string">"insert into "</span> + tableName + <span class="string">" (createtime, content) values (?, ?)"</span>);</span><br><span class="line">                    stmt.setString(<span class="number">1</span>, createtime);</span><br><span class="line">                    stmt.setString(<span class="number">2</span>, body);</span><br><span class="line">                    stmt.execute();</span><br><span class="line">                    stmt.close();</span><br><span class="line">                    status = Status.READY;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    status = Status.BACKOFF;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            txn.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t)&#123;</span><br><span class="line">            txn.rollback();</span><br><span class="line">            t.getCause().printStackTrace();</span><br><span class="line">            status = Status.BACKOFF;</span><br><span class="line">        &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">            txn.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取配置文件中指定的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mysqlurl = context.getString(<span class="string">"mysqlurl"</span>);</span><br><span class="line">        username = context.getString(<span class="string">"username"</span>);</span><br><span class="line">        password = context.getString(<span class="string">"password"</span>);</span><br><span class="line">        tableName = context.getString(<span class="string">"tablename"</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">              <span class="comment">//初始化数据库连接</span></span><br><span class="line">            con = DriverManager.getConnection(mysqlurl, username, password);</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">            System.out.println(<span class="string">"finish start"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            con.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>4、测试</p>
<ul>
<li><p>4.1 程序打成jar包，上传jar包到flume的lib目录下</p>
</li>
<li><p>4.2 配置文件准备</p>
<ul>
<li>vim mysqlsink.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置source</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /kkb/install/flumeData/data.log</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line">#配置channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line">#配置sink</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinks.k1.type = com.kaikeba.sink.MysqlSink</span><br><span class="line">a1.sinks.k1.mysqlurl=jdbc:mysql://node01:3306/mysqlsource?useSSL=false</span><br><span class="line">a1.sinks.k1.username=root</span><br><span class="line">a1.sinks.k1.password=123456</span><br><span class="line">a1.sinks.k1.tablename=flume2mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>4.3 启动flume配置</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/mysqlsink.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>4.4 最后向文件中添加数据，观察mysql表中的数据</li>
</ul>
</li>
</ul>
<h3 id="10-Flume实际使用注意事项"><a href="#10-Flume实际使用注意事项" class="headerlink" title="10. Flume实际使用注意事项"></a>10. Flume实际使用注意事项</h3><ul>
<li>1、注意启动脚本命名的书写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent 的名称别写错了，后台执行加上 nohup ... &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>2、channel参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">capacity：默认该通道中最大的可以存储的event数量</span><br><span class="line">trasactionCapacity：每次最大可以从source中拿到或者送到sink中的event数量</span><br><span class="line">注意：capacity &gt; trasactionCapacity</span><br></pre></td></tr></table></figure>

<ul>
<li>3、日志采集到HDFS配置说明1（sink端）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义sink</span></span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path=hdfs://node01:8020/source/logs/%&#123;type&#125;/%Y%m%d</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix =events</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line">a1.sinks.k1.hdfs.writeFormat = Text</span><br><span class="line"><span class="meta">#</span><span class="bash">时间类型</span></span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line"><span class="meta">#</span><span class="bash">生成的文件不按条数生成</span></span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 0</span><br><span class="line"><span class="meta">#</span><span class="bash">生成的文件按时间生成</span></span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 0</span><br><span class="line"><span class="meta">#</span><span class="bash">生成的文件按大小生成</span></span><br><span class="line">a1.sinks.k1.hdfs.rollSize  = 10485760</span><br><span class="line"><span class="meta">#</span><span class="bash">批量写入hdfs的个数</span></span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 10000</span><br><span class="line"><span class="meta">#</span><span class="bash">flume操作hdfs的线程数（包括新建，写入等）</span></span><br><span class="line">a1.sinks.k1.hdfs.threadsPoolSize=10</span><br><span class="line"><span class="meta">#</span><span class="bash">操作hdfs超时时间</span></span><br><span class="line">a1.sinks.k1.hdfs.callTimeout=30000</span><br></pre></td></tr></table></figure>

<ul>
<li>4、日志采集到HDFS配置说明2（sink端）</li>
</ul>
<table>
<thead>
<tr>
<th>hdfs.round</th>
<th>false</th>
<th>Should the timestamp be rounded down (if true, affects all time based escape sequences except %t)</th>
</tr>
</thead>
<tbody><tr>
<td>hdfs.roundValue</td>
<td>1</td>
<td>Rounded down to the highest multiple of this (in the unit configured usinghdfs.roundUnit), less than current time.</td>
</tr>
<tr>
<td>hdfs.roundUnit</td>
<td>second</td>
<td>The unit of the round down value - second, minute or hour.</td>
</tr>
</tbody></table>
<p>Ø round： 默认值：false 是否启用时间上的”舍弃”，这里的”舍弃”，类似于”四舍五入”</p>
<p>Ø roundValue：默认值：1  时间上进行“舍弃”的值；</p>
<p>Ø roundUnit： 默认值：seconds时间上进行”舍弃”的单位，包含：second,minute,hour</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">y案例一：</span><br><span class="line">a1.sinks.k1.hdfs.path = /flume/events/%Y-%m-%d/%H:%M/%S</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">当时间为2015-10-16 17:38:59时候，hdfs.path依然会被解析为：</span><br><span class="line">/flume/events/2015-10-16/17:30/00</span><br><span class="line">/flume/events/2015-10-16/17:40/00</span><br><span class="line">/flume/events/2015-10-16/17:50/00</span><br><span class="line">因为设置的是舍弃10分钟内的时间，因此，该目录每10分钟新生成一个。</span><br><span class="line"></span><br><span class="line">案例二：</span><br><span class="line">a1.sinks.k1.hdfs.path = /flume/events/%Y-%m-%d/%H:%M/%S</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = second</span><br><span class="line">现象：10秒为时间梯度生成对应的目录，目录下面包括很多小文件！！！</span><br><span class="line">格式如下：</span><br><span class="line">/flume/events/2016-07-28/18:45/10</span><br><span class="line">/flume/events/2016-07-28/18:45/20</span><br><span class="line">/flume/events/2016-07-28/18:45/30</span><br><span class="line">/flume/events/2016-07-28/18:45/40</span><br><span class="line">/flume/events/2016-07-28/18:45/50</span><br><span class="line">/flume/events/2016-07-28/18:46/10</span><br><span class="line">/flume/events/2016-07-28/18:46/20</span><br><span class="line">/flume/events/2016-07-28/18:46/30</span><br><span class="line">/flume/events/2016-07-28/18:46/40</span><br><span class="line">/flume/events/2016-07-28/18:46/50</span><br></pre></td></tr></table></figure>

<ul>
<li><p>5、实现数据的断点续传</p>
<ul>
<li>当一个flume挂掉之后重启的时候还是可以接着上一次的数据继续收集<ul>
<li>flume在1.7版本之前使用的监控一个文件（source exec）、监控一个目录（source spooldir）都无法直接实现</li>
</ul>
</li>
<li>flume在1.7版本之后已经集成了该功能<ul>
<li>其本质就是记录下每一次消费的位置，把消费信息的位置保存到文件中，后续程序挂掉了再重启的时候，可以接着上一次消费的数据位置继续拉取。</li>
</ul>
</li>
<li>配置文件<ul>
<li>vim taildir.conf<ul>
<li>source 类型—-&gt;taildir</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = s1</span><br><span class="line">a1.channels = ch1</span><br><span class="line">a1.sinks = hdfs-sink1</span><br><span class="line"></span><br><span class="line">#channel</span><br><span class="line">a1.channels.ch1.type = memory</span><br><span class="line">a1.channels.ch1.capacity=10000</span><br><span class="line">a1.channels.ch1.transactionCapacity=500</span><br><span class="line"></span><br><span class="line">#source</span><br><span class="line">a1.sources.s1.channels = ch1</span><br><span class="line">#监控一个目录下的多个文件新增的内容</span><br><span class="line">a1.sources.s1.type = taildir</span><br><span class="line">#通过 json 格式存下每个文件消费的偏移量，避免从头消费</span><br><span class="line">a1.sources.s1.positionFile = /install/flumeData/index/taildir_position.json</span><br><span class="line">a1.sources.s1.filegroups = f1 f2 f3 </span><br><span class="line">a1.sources.s1.filegroups.f1 = /home/hadoop/taillogs/access.log</span><br><span class="line">a1.sources.s1.filegroups.f2 = /home/hadoop/taillogs/nginx.log</span><br><span class="line">a1.sources.s1.filegroups.f3 = /home/hadoop/taillogs/web.log</span><br><span class="line">a1.sources.s1.headers.f1.headerKey = access</span><br><span class="line">a1.sources.s1.headers.f2.headerKey = nginx</span><br><span class="line">a1.sources.s1.headers.f3.headerKey = web</span><br><span class="line">a1.sources.s1.fileHeader  = true</span><br><span class="line"></span><br><span class="line">##sink</span><br><span class="line">a1.sinks.hdfs-sink1.channel = ch1</span><br><span class="line">a1.sinks.hdfs-sink1.type = hdfs</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.path =hdfs://node01:8020/demo/data/%&#123;headerKey&#125;</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.filePrefix = event_data</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.fileSuffix = .log</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.rollSize = 1048576</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.rollInterval =20</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.rollCount = 10</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.batchSize = 1500</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.round = true</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.threadsPoolSize = 25</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.fileType =DataStream</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.writeFormat = Text</span><br><span class="line">a1.sinks.hdfs-sink1.hdfs.callTimeout = 60000</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">运行后生成的 taildir_position.json文件信息如下：</span><br><span class="line">[</span><br><span class="line">&#123;&quot;inode&quot;:102626782,&quot;pos&quot;:123,&quot;file&quot;:&quot;/home/hadoop/taillogs/access.log&quot;&#125;,&#123;&quot;inode&quot;:102626785,&quot;pos&quot;:123,&quot;file&quot;:&quot;/home/hadoop/taillogs/web.log&quot;&#125;,&#123;&quot;inode&quot;:102626786,&quot;pos&quot;:123,&quot;file&quot;:&quot;/home/hadoop/taillogs/nginx.log&quot;&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">这里inode就是标记文件的，文件名称改变，这个iNode不会变，pos记录偏移量，file就是绝对路径</span><br></pre></td></tr></table></figure>

<ul>
<li>6、flume的header参数配置讲解<ul>
<li>vim test-header.conf    </li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#配置信息test-header.conf</span><br><span class="line">a1.channels=c1</span><br><span class="line">a1.sources=r1</span><br><span class="line">a1.sinks=k1</span><br><span class="line"></span><br><span class="line">#source</span><br><span class="line">a1.sources.r1.channels=c1</span><br><span class="line">a1.sources.r1.type= spooldir</span><br><span class="line">a1.sources.r1.spoolDir= /home/hadoop/test</span><br><span class="line">a1.sources.r1.batchSize= 100</span><br><span class="line">a1.sources.r1.inputCharset= UTF-8</span><br><span class="line">#是否添加一个key存储目录下文件的绝对路径</span><br><span class="line">a1.sources.r1.fileHeader= true</span><br><span class="line">#指定存储目录下文件的绝对路径的key</span><br><span class="line">a1.sources.r1.fileHeaderKey= mm</span><br><span class="line">#是否添加一个key存储目录下的文件名称</span><br><span class="line">a1.sources.r1.basenameHeader= true</span><br><span class="line">#指定存储目录下文件的名称的key</span><br><span class="line">a1.sources.r1.basenameHeaderKey= nn</span><br><span class="line"></span><br><span class="line">#channel</span><br><span class="line">a1.channels.c1.type= memory</span><br><span class="line">a1.channels.c1.capacity=10000</span><br><span class="line">a1.channels.c1.transactionCapacity=500</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#sink</span><br><span class="line">a1.sinks.k1.type=logger</span><br><span class="line">a1.sinks.k1.channel=c1</span><br></pre></td></tr></table></figure>

<ul>
<li>准备数据文件，添加内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/home/hadoop/test/abc.txt</span><br><span class="line">/home/hadoop/test/def.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>启动flume配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -n a1 -c myconf -f myconf/test-header.conf -Dflume.root.logger=info,console</span><br></pre></td></tr></table></figure>

<ul>
<li>查看控制台</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Event: &#123; headers:&#123;mm=/home/hadoop/test/abc.txt, nn=abc.txt&#125; body: 68 65 6C 6C 6F 20 73 70 61 72 6B                hello spark &#125;</span><br><span class="line">19/08/30 19:23:15 INFO sink.LoggerSink: Event: &#123; headers:&#123;mm=/home/hadoop/test/abc.txt, nn=abc.txt&#125; body: 68 65 6C 6C 6F 20 68 61 64 6F 6F 70             hello hadoop &#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-总结"><a href="#11-总结" class="headerlink" title="11. 总结"></a>11. 总结</h3><p><img src="/2020/03/06/Flume日志采集框架/Flume%E6%80%BB%E7%BB%93.png" alt></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/fish.png"
      alt="小鱼儿">
  <p class="site-author-name" itemprop="name">小鱼儿</p>
  <div class="site-description" itemprop="description">肩膀有点痒，可能在长小翅膀</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    
  
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小鱼儿</span>
</div>

        












        
      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/pisces.js?v=7.4.1"></script>

<script src="/js/next-boot.js?v=7.4.1"></script>



  





















  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

